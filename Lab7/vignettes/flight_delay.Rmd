---
title: "Flight Delay"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Flight Delay}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
suppressMessages(library(nycflights13))
suppressMessages(library(dplyr))
suppressMessages(library(caret))

weather.drop_cols <- c("year", "month", "day", "hour")
weather.compact <- weather %>% select(-one_of(weather.drop_cols))

flights.drop_cols <- c("year", "month", "day", "hour", "minute", "dest", "air_time", "distance",
                       "carrier", "sched_dep_time", "dep_time", "sched_arr_time", "arr_time", "flight", "tailnum")
flights.compact <- flights %>% select(-one_of(flights.drop_cols))

data <- flights.compact %>% left_join(weather.compact) %>% filter(!is.na(dep_delay))

impute.mean <- function(x) replace(x, is.na(x), mean(x, na.rm = TRUE))

imputed_data <- data %>% group_by(origin) %>% mutate(temp = impute.mean(temp),
                                     dewp = impute.mean(dewp),
                                     humid = impute.mean(humid),
                                     wind_dir= impute.mean(wind_dir),
                                     wind_speed= impute.mean(wind_speed),
                                     wind_gust= impute.mean(wind_gust),
                                     precip = impute.mean(precip),
                                     pressure = impute.mean(pressure),
                                     visib = impute.mean(visib))


set.seed(123)
train_idx <- createDataPartition(imputed_data$dep_delay, p=0.85, list=FALSE)
validation_idx <- sample(1:length(train_idx), nrow(imputed_data) * 0.05)

training <- imputed_data[train_idx,]
testing <- imputed_data[-train_idx,]


## Ridge Regressions (Should use our own implementation)
train_control <- trainControl(method="cv", index=list(Fold1=validation_idx), number=1, repeats=1)

?trainControl

ridge.fit <- train(dep_delay ~ temp + dewp + humid, data=training, method="ridge", 
                  trControl=train_control, preProc=c("center", "scale"))

ridge.train_predict <- predict(ridge.fit, newdata=training)
training_mse <- mean((training$dep_delay - ridge.train_predict)^2)
training_mse

ridge.test_predict <- predict(ridge.fit, newdata=testing)
testing_mse <- mean((testing$dep_delay - ridge.test_predict)^2)
testing_mse
```
