---
title: "Flight Delay"
author: "Rasmus Holm"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Flight Delay}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Flight Data

Here we are going to predict the delay of each flight from the flights data set in package `nycflights13`.

## Data Processing

The first thing we do is the remove variables that we do not consider useful in the prediction task. Then we join the flight data with the weather data to have all the necessary data in a single data frame. Some values are missing so we choose to do imputation by using the mean values.

```{r}
suppressMessages(require(nycflights13))
suppressMessages(require(dplyr))
suppressMessages(require(caret))
suppressMessages(require(lars))
suppressMessages(require(elasticnet))
suppressMessages(require(Lab7))

weather.drop_cols <- c("year", "month", "day", "hour")
weather.compact <- weather %>% select(-one_of(weather.drop_cols))

flights.drop_cols <- c("year", "month", "day", "hour", "minute", "dest", "air_time", "distance",
                       "carrier", "sched_dep_time", "dep_time", "sched_arr_time", "arr_time",
                       "flight", "tailnum")
flights.compact <- flights %>% select(-one_of(flights.drop_cols))

data <- flights.compact %>% left_join(weather.compact, by=c("origin", "time_hour")) %>% filter(!is.na(dep_delay))

impute.mean <- function(x) replace(x, is.na(x), mean(x, na.rm = TRUE))

imputed_data <- data %>% group_by(origin) %>% mutate(temp = impute.mean(temp),
                                                     dewp = impute.mean(dewp),
                                                     humid = impute.mean(humid),
                                                     wind_dir= impute.mean(wind_dir),
                                                     wind_speed= impute.mean(wind_speed),
                                                     wind_gust= impute.mean(wind_gust),
                                                     precip = impute.mean(precip),
                                                     pressure = impute.mean(pressure),
                                                     visib = impute.mean(visib))
```

## Training

In this example we create a training set (80%), test set (15%), and validation set(5%) to optimize our parameters.

```{R}
set.seed(123)
train_idx <- createDataPartition(imputed_data$dep_delay, p=0.85, list=FALSE)
validation_idx <- sample(1:length(train_idx), nrow(imputed_data) * 0.05)

training <- imputed_data[train_idx,][-validation_idx,]
testing <- imputed_data[-train_idx,]
validation <- imputed_data[train_idx,][validation_idx,]
```

We are going to use ridge regression to do our prediction and the first thing we are going to do is find a good lambda parameter by training using our training set and then measure the performance on the validation set based on the root mean squared error.

```{r}
rmse <- function(error) {
    return(sqrt(mean(error^2)))
}

ridge.train_control <- trainControl(method="cv", number=5)
ridge.formula <- as.formula(dep_delay ~ temp + dewp)

lambdas <- c(0, 0.001, 0.01, 0.1, 1, 1, 10, 100, 1000)

min_rmse <- Inf
best_lambda <- NULL

for (lambda in lambdas) {
    ridge.grid <- expand.grid(lambda=lambda)
    ridge.fit <- train(ridge.formula, data=training, method=cridgereg,
                       tuneGrid=ridge.grid, trControl=ridge.train_control)

    ridge.validation_predict <- predict(ridge.fit, newdata=validation)
    validation_rmse <- rmse(validation$dep_delay - ridge.validation_predict)

    if (validation_rmse < min_rmse) {
        min_rmse <- validation_rmse
        best_lambda <- lambda
    }
}

print(paste("Best lambda found:", best_lambda, sep=" "))
```

## Performance Measure

We have now found our optimal lambda and it is now time to test the classifier for real. First we train it again but now we use both the training and validation set. Then we measure the performance using root mean squared error on both the trained data and the test data.

```{r}
ridge.fit <- train(ridge.formula, data=rbind(training, validation), method=cridgereg,
                   tuneGrid=expand.grid(lambda=best_lambda), trControl=ridge.train_control)

ridge.train_predict <- predict(ridge.fit, newdata=rbind(training, validation))
training_rmse <- rmse(rbind(training, validation)$dep_delay - ridge.train_predict)
print(paste("Training RMSE:", training_rmse, sep=" "))

ridge.test_predict <- predict(ridge.fit, newdata=testing)
testing_rmse <- rmse(testing$dep_delay - ridge.test_predict)
print(paste("Testing RMSE:", testing_rmse, sep=" "))
```
